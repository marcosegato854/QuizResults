<!DOCTYPE html>
<html lang="it">
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Raleway&display=swap"
      rel="stylesheet"
    />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Admin</title>
    <script>
      let ws = new WebSocket("ws://localhost:8080");
      let adminToken = null;
      let quizInCorso = false;

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === "login_success") {
          adminToken = data.token;
          document.getElementById("adminPanel").style.display = "block";
          document.getElementById("loginPanel").style.display = "none";
        } else if (data.type === "status" || data.type === "update") {
          document.getElementById("domandaCorrente").innerText =
            "Domanda corrente: " + data.domandaAttuale;
          document.getElementById("risultati").innerHTML = renderResults(
            data.responses
          );

          quizInCorso = data.quizInCorso;
          aggiornaStatoPulsanti(data);
        }
      };

      function login() {
        const password = document.getElementById("password").value;
        ws.send(JSON.stringify({ type: "login", password }));
      }

      function startQuiz() {
        const numDomande = parseInt(document.getElementById("numDomande").value);
        const materia = document.getElementById("Materia").value;
        ws.send(
          JSON.stringify({
            type: "admin",
            action: "start",
            numDomande,
            materia,
            token: adminToken,
          })
        );

        // ðŸ”¥ Disattiva "Avvia Quiz" e attiva gli altri
        document.getElementById("btnStart").disabled = true;
        document.getElementById("btnNext").disabled = false;
        document.getElementById("btnStop").disabled = false;
      }

      function nextQuestion() {
        ws.send(
          JSON.stringify({ type: "admin", action: "next", token: adminToken })
        );
      }

      function stopQuiz() {
        ws.send(
          JSON.stringify({ type: "admin", action: "stop", token: adminToken })
        );

        // ðŸ”¥ Riattiva "Avvia Quiz" e disattiva gli altri
        document.getElementById("btnStart").disabled = false;
        document.getElementById("btnNext").disabled = true;
        document.getElementById("btnStop").disabled = true;
      }

      function aggiornaStatoPulsanti(data) {
        let btnNext = document.getElementById("btnNext");

        // ðŸ”¥ Disattiva "Prossima Domanda" se siamo all'ultima domanda
        btnNext.disabled = data.domandaAttuale >= data.numDomande;
      }

      function renderResults(results) {
        let html = "";
        let totaleRisposte = 0;
        for (let domanda in results) {
          totaleRisposte =
            results[domanda].A +
            results[domanda].B +
            results[domanda].C +
            results[domanda].D;
          html += `<span class="domandaSpan">${domanda} </span><span class="risposteSpan">A:${results[domanda].A}, B:${results[domanda].B}, C:${results[domanda].C}, D:${results[domanda].D} | Totale risposte:${totaleRisposte}</span><br>`;
        }
        return html;
      }
    </script>

    <link rel="stylesheet" href="admin.css" />
  </head>
  <body>
    <div class="main">
      <h1>Dashboard Admin</h1>

      <div id="adminPanel" style="display: block">
        <h2>Gestione Quiz</h2>
        <div class="inputTest">
          <input type="text" id="Materia" placeholder="Materia Esame" />
          <input type="number" id="numDomande" placeholder="Numero di domande" />
        </div>
        <div class="buttonsTest">
          <button id="btnStart" class="startBtn" onclick="startQuiz()">
            Avvia Quiz
          </button>
          <button id="btnNext" class="nextBtn" onclick="nextQuestion()" disabled>
            Prossima Domanda
          </button>
          <button id="btnStop" class="stopBtn" onclick="stopQuiz()" disabled>
            Termina Quiz
          </button>
        </div>

        <h3 id="domandaCorrente">Domanda Corrente: 0</h3>

        <h2>Risultati</h2>
        <div id="risultati"></div>
      </div>
    </div>
  </body>
</html>
